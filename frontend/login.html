<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - Ensaladazo!</title>
    <link rel="stylesheet" href="CSS/styles-login.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
    </style>
</head>
<body>
    <div class="background-pattern"></div>
    <div class="background-leaves"></div>

    <div class="login-wrapper">
        <div class="login-container">
            <div class="login-header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i data-lucide="salad" size="35"></i>
                    </div>
                </div>
                <h2 class="welcome-back">¡Bienvenido <span class="highlight">de nuevo</span>!</h2>
                <p class="login-subtitle">Inicia sesión en tu cuenta</p>
            </div>

            <form id="login-form">
                <div class="form-group">
                    <label for="username" class="form-label">Usuario o Email</label>
                    <div class="input-with-icon">
                        <i data-lucide="user" class="input-icon" size="20"></i>
                        <input type="text" id="username" class="form-input" placeholder="Tu usuario o email" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">Contraseña</label>
                    <div class="input-with-icon">
                        <i data-lucide="lock" class="input-icon" size="20"></i>
                        <input type="password" id="password" class="form-input" placeholder="Tu contraseña" required>
                        <button type="button" class="password-toggle" id="toggle-password">
                            <i data-lucide="eye" size="18"></i>
                        </button>
                    </div>
                </div>

                <div class="login-options">
                    <label class="remember-me">
                        <input type="checkbox" id="remember-me">
                        <span>Recordar mi sesión</span>
                    </label>
                    <a href="#" class="forgot-password">¿Olvidaste tu contraseña?</a>
                </div>

                <button type="submit" class="login-btn" id="login-btn">
                    <i data-lucide="log-in" size="20"></i>
                    Iniciar Sesión
                </button>
            </form>

            <div class="divider">
                <span>O inicia sesión con</span>
            </div>

            <div class="social-login">
                <button type="button" class="social-btn google">
                    <i data-lucide="mail" size="16"></i>
                    Google
                </button>
                <button type="button" class="social-btn facebook">
                    <i data-lucide="facebook" size="16"></i>
                    Facebook
                </button>
            </div>

            <p class="register-link">
                ¿No tienes cuenta? <a href="register.html">Regístrate aquí</a>
            </p>

            <p id="login-message"></p>
        </div>
    </div>

    <script>
        // Inicializar íconos de Lucide
        lucide.createIcons();

        // Toggle para mostrar/ocultar contraseña
        document.getElementById('toggle-password').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                passwordInput.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        });

        // Manejo del formulario de login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const rememberMe = document.getElementById('remember-me').checked;
            const loginMessage = document.getElementById('login-message');
            const loginBtn = document.getElementById('login-btn');

            // Mostrar estado de carga
            loginMessage.textContent = 'Iniciando sesión...';
            loginMessage.className = 'info';
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i data-lucide="loader" class="loading-spinner"></i> Iniciando sesión...';
            lucide.createIcons();

            try {
                // Preparar datos para enviar
                const data = new URLSearchParams();
                data.append("username", username);
                data.append("password", password);

                const response = await fetch("http://localhost:3050/api/auth/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (response.ok) {
                    // Guardar token y datos de usuario
                    localStorage.setItem("token", result.access_token);
                    localStorage.setItem("username", result.username);
                    
                    // Guardar preferencia de "recordar sesión"
                    if (rememberMe) {
                        localStorage.setItem("rememberMe", "true");
                    } else {
                        localStorage.removeItem("rememberMe");
                    }

                    loginMessage.textContent = "✅ ¡Inicio de sesión exitoso! Redirigiendo...";
                    loginMessage.className = "success";
                    
                    // Animación de éxito
                    loginBtn.style.background = 'var(--success)';
                    
                    // Redirigir después de un breve delay
                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 1500);
                } else {
                    loginMessage.textContent = "❌ " + (result.message || "Credenciales incorrectas");
                    loginMessage.className = "error";
                    
                    // Restaurar botón
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i data-lucide="log-in" size="20"></i> Iniciar Sesión';
                    lucide.createIcons();
                }
            } catch (error) {
                console.error("Error de conexión:", error);
                loginMessage.textContent = "⚠️ Error de conexión con el servidor. Intenta nuevamente.";
                loginMessage.className = "error";
                
                // Restaurar botón
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i data-lucide="log-in" size="20"></i> Iniciar Sesión';
                lucide.createIcons();
            }
        });

        // Botones de redes sociales (funcionalidad básica)
        document.querySelector('.social-btn.google').addEventListener('click', function() {
            document.getElementById('login-message').textContent = 'Inicio de sesión con Google en desarrollo';
            document.getElementById('login-message').className = 'info';
        });

        document.querySelector('.social-btn.facebook').addEventListener('click', function() {
            document.getElementById('login-message').textContent = 'Inicio de sesión con Facebook en desarrollo';
            document.getElementById('login-message').className = 'info';
        });

        // Enlace "olvidé mi contraseña"
        document.querySelector('.forgot-password').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('login-message').textContent = 'Funcionalidad de recuperación de contraseña en desarrollo';
            document.getElementById('login-message').className = 'info';
        });

        // Cargar datos guardados si existe "recordar sesión"
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem("rememberMe") === "true") {
                document.getElementById('remember-me').checked = true;
                // Aquí podrías cargar automáticamente el usuario si lo guardaste de forma segura
            }
        });

        // Asegurar que la página sea scrollable
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';
    </script>
</body>
</html>