<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi√≥n - Ensaladazo!</title>
    <link rel="stylesheet" href="CSS/styles-login.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
    </style>
</head>
<body>
    <div class="background-pattern"></div>
    <div class="background-leaves"></div>

    <div class="login-wrapper">
        <div class="login-container">
            <div class="login-header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i data-lucide="salad" size="35"></i>
                    </div>
                </div>
                <h2 class="welcome-back">¬°Bienvenido <span class="highlight">de nuevo</span>!</h2>
                <p class="login-subtitle">Inicia sesi√≥n en tu cuenta</p>
            </div>

            <form id="login-form">
                <div class="form-group">
                    <label for="username" class="form-label">Usuario o Email</label>
                    <div class="input-with-icon">
                        <i data-lucide="user" class="input-icon" size="20"></i>
                        <input type="text" id="username" class="form-input" placeholder="Tu usuario o email" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">Contrase√±a</label>
                    <div class="input-with-icon">
                        <i data-lucide="lock" class="input-icon" size="20"></i>
                        <input type="password" id="password" class="form-input" placeholder="Tu contrase√±a" required>
                        <button type="button" class="password-toggle" id="toggle-password">
                            <i data-lucide="eye" size="18"></i>
                        </button>
                    </div>
                </div>

                <div class="login-options">
                    <label class="remember-me">
                        <input type="checkbox" id="remember-me">
                        <span>Recordar mi sesi√≥n</span>
                    </label>
                    <a href="#" class="forgot-password">¬øOlvidaste tu contrase√±a?</a>
                </div>

                <button type="submit" class="login-btn" id="login-btn">
                    <i data-lucide="log-in" size="20"></i>
                    Iniciar Sesi√≥n
                </button>
            </form>

            <div class="divider">
                <span>O inicia sesi√≥n con</span>
            </div>

            <div class="social-login">
                <button type="button" class="social-btn google">
                    <i data-lucide="mail" size="16"></i>
                    Google
                </button>
                <button type="button" class="social-btn facebook">
                    <i data-lucide="facebook" size="16"></i>
                    Facebook
                </button>
            </div>

            <p class="register-link">
                ¬øNo tienes cuenta? <a href="register.html">Reg√≠strate aqu√≠</a>
            </p>

            <p id="login-message"></p>
        </div>
    </div>

    <script>
        // Inicializar √≠conos de Lucide
        lucide.createIcons();

        // URL del backend (debe coincidir con Inicio.js)
        const API_URL = 'http://localhost:3050';

        // Toggle para mostrar/ocultar contrase√±a
        document.getElementById('toggle-password').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                passwordInput.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        });

        // Manejo del formulario de login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const rememberMe = document.getElementById('remember-me').checked;
            const loginMessage = document.getElementById('login-message');
            const loginBtn = document.getElementById('login-btn');

            // Mostrar estado de carga
            loginMessage.textContent = 'Iniciando sesi√≥n...';
            loginMessage.className = 'info';

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i data-lucide="loader" class="loading-spinner"></i> Iniciando sesi√≥n...';
            lucide.createIcons();

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('‚úÖ Login exitoso:', result);

                    // Guardar token y datos de usuario
                    localStorage.setItem("token", result.access_token);
                    localStorage.setItem("username", result.username);

                    // Guardar preferencia de "recordar sesi√≥n"
                    if (rememberMe) {
                        localStorage.setItem("rememberMe", "true");
                    } else {
                        localStorage.removeItem("rememberMe");
                    }

                    loginMessage.textContent = "‚úÖ ¬°Inicio de sesi√≥n exitoso! Migrando carrito...";
                    loginMessage.className = "success";

                    // Animaci√≥n de √©xito
                    loginBtn.style.background = 'var(--success, #4CAF50)';

                    // **MIGRAR CARRITO ANTES DE REDIRECCIONAR**
                    try {
                        const tempSession = localStorage.getItem('user_session');

                        if (tempSession && tempSession.startsWith('temp_')) {
                            console.log('üîÑ Migrando carrito temporal...');

                            const migrateResponse = await fetch(`${API_URL}/api/cart/migrate`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    temp_session: tempSession,
                                    new_session: `user_${result.username}`
                                })
                            });

                            if (migrateResponse.ok) {
                                console.log('‚úÖ Carrito migrado exitosamente');
                                // Limpiar sesi√≥n temporal
                                localStorage.removeItem('user_session');
                            }
                        }
                    } catch (migrateError) {
                        console.warn('‚ö†Ô∏è Error al migrar carrito, pero continuando...', migrateError);
                    }

                    // Redirigir despu√©s de migrar
                    loginMessage.textContent = "‚úÖ ¬°Todo listo! Redirigiendo...";

                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 1000);

                } else {
                    loginMessage.textContent = "‚ùå " + (result.message || "Credenciales incorrectas");
                    loginMessage.className = "error";

                    // Restaurar bot√≥n
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i data-lucide="log-in" size="20"></i> Iniciar Sesi√≥n';
                    lucide.createIcons();
                }
            } catch (error) {
                console.error("Error de conexi√≥n:", error);
                loginMessage.textContent = "‚ö†Ô∏è Error de conexi√≥n con el servidor. Intenta nuevamente.";
                loginMessage.className = "error";

                // Restaurar bot√≥n
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i data-lucide="log-in" size="20"></i> Iniciar Sesi√≥n';
                lucide.createIcons();
            }
        });

        // Botones de redes sociales (funcionalidad b√°sica)
        document.querySelector('.social-btn.google').addEventListener('click', function() {
            document.getElementById('login-message').textContent = 'Inicio de sesi√≥n con Google en desarrollo';
            document.getElementById('login-message').className = 'info';
        });

        document.querySelector('.social-btn.facebook').addEventListener('click', function() {
            document.getElementById('login-message').textContent = 'Inicio de sesi√≥n con Facebook en desarrollo';
            document.getElementById('login-message').className = 'info';
        });

        // Enlace "olvid√© mi contrase√±a"
        document.querySelector('.forgot-password').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('login-message').textContent = 'Funcionalidad de recuperaci√≥n de contrase√±a en desarrollo';
            document.getElementById('login-message').className = 'info';
        });

        // Cargar datos guardados si existe "recordar sesi√≥n"
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem("rememberMe") === "true") {
                document.getElementById('remember-me').checked = true;
            }

            // Si ya est√° logueado, redireccionar
            if (localStorage.getItem("token") && localStorage.getItem("username")) {
                window.location.href = "index.html";
            }
        });

        // Asegurar que la p√°gina sea scrollable
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';
    </script>
</body>
</html>